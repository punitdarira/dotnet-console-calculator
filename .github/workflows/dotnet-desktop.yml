name: .NET Core

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # Install the .NET Core workload
    - name: Install .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    # Add MSBuild to the PATH: https://github.com/microsoft/setup-msbuild
    - name: Setup MSBuild.exe
      uses: microsoft/setup-msbuild@v2

    # Execute all unit tests in the solution and collect code coverage
    - name: Execute unit tests
      run: dotnet test --collect:"XPlat Code Coverage"

    # Install ReportGenerator to generate code coverage report
    - name: Install ReportGenerator
      run: dotnet tool install -g dotnet-reportgenerator-globaltool

    # Generate code coverage report
    - name: Generate code coverage report
      run: reportgenerator -reports:**/coverage.cobertura.xml -targetdir:coverage -reporttypes:Html

    # Check code coverage threshold
    - name: Check code coverage
      run: |
        COVERAGE=$(grep -oP 'line-rate="\K[0-9.]+' coverage/cobertura.xml)
        if (( $(echo "$COVERAGE < 0.80" | bc -l) )); then
          echo "Code coverage is below 80% ($COVERAGE)"
          exit 1
        else
          echo "Code coverage is sufficient ($COVERAGE)"
        fi